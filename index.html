<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ZEROMM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#0f0f0f;
      --bg-elev:#181818;
      --panel:#121212;
      --panel-2:#1b1b1b;
      --text:#fff;
      --muted:#b3b3b3;
      --brand:#1DB954;
      --card:#232a36;
      --player-h:84px;
      --sidebar-w:250px;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui, -apple-system, 'Noto Sans KR', Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      overflow:hidden; /* ê°€ì‚¬ ì˜¤ë²„ë ˆì´ ë“± ë ˆì´ì•„ì›ƒ ê³ ì • */
    }

    /* ===== ë ˆì´ì•„ì›ƒ ===== */
    .app{
      height:100%;
      display:grid;
      grid-template-columns: var(--sidebar-w) 1fr;
      grid-template-rows: 1fr var(--player-h);
      grid-template-areas:
        "sidebar main"
        "player  player";
    }

    /* ===== ì‚¬ì´ë“œë°” ===== */
    .sidebar{
      grid-area:sidebar;
      background:linear-gradient(180deg, #0f0f0f 0%, #121212 100%);
      border-right:1px solid #000;
      padding:18px 14px 14px;
      overflow:auto;
    }
    .logo{
      display:flex; align-items:center; gap:10px;
      padding:8px 6px 16px;
      font-weight:800; letter-spacing:.5px;
      font-size:20px;
    }
    .logo .dot{width:20px;height:20px;border-radius:50%;background:var(--brand)}
    .side-section-title{
      font-size:12px; color:var(--muted); margin:18px 8px 8px;
      text-transform:uppercase; letter-spacing:.8px;
    }
    .nav{
      display:flex; flex-direction:column; gap:6px; padding:0 6px;
    }
    .nav a{
      padding:10px 12px; border-radius:10px; color:#ddd; text-decoration:none;
      display:flex; align-items:center; gap:10px;
    }
    .nav a:hover, .nav a.active{ background:#1a1a1a; color:#fff; }

    .install-app{
      margin-top:14px;
      background:#151515; border:1px solid #202020;
      border-radius:12px; padding:12px;
    }
    .install-app .title{font-weight:700;margin-bottom:8px}
    .upload-wrap{
      display:flex; flex-direction:column; gap:8px;
      background:#0f0f0f; border:1px dashed #2b2b2b; padding:10px; border-radius:10px;
    }
    .folderInput{
      appearance:none; border:none; border-radius:100px; padding:10px 12px;
      background:var(--brand); color:#111; font-weight:800; cursor:pointer; text-align:center;
    }
    .searchInput{
      width:100%;
      background:#1a1a1a; border:1px solid #262626; color:#fff;
      padding:10px 12px; border-radius:100px; outline:none;
    }

    /* ===== ë©”ì¸ ===== */
.main {
  grid-area: main;
  overflow-y: auto;
  padding: 18px 24px 120px 24px;

  background: linear-gradient(
      to bottom,
      rgba(29,185,84,0.6) 0px,
      rgba(29,185,84,0.4) 30px,
      rgba(29,185,84,0.25) 60px,
      rgba(29,185,84,0.15) 90px,
      rgba(29,185,84,0.08) 120px,
      rgba(29,185,84,0.03) 150px,
      rgba(29,185,84,0) 180px
    ),
    var(--panel);
}

    .top-tabs{
      display:flex; gap:18px; align-items:center; margin:4px 0 16px;
      position:sticky; top:0; background:transparent; backdrop-filter:blur(6px);
      z-index:5;
    }
    .tabBtn{
      border:none; background:#212121; color:#fff; padding:10px 18px; border-radius:999px;
      cursor:pointer; font-weight:700; letter-spacing:.2px;
    }
    .tabBtn.active{ background:var(--brand); color:#111; }
    .section-title{ font-size:24px; font-weight:800; margin:10px 0 10px 2px; }

    /* ì¹´ë“œ ê·¸ë¦¬ë“œ */
    .card-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap:18px;
    }
    .card{
      background:#181a20; border-radius:16px; padding:12px;
      transition:transform .18s ease, background .18s ease, box-shadow .18s ease;
      cursor:pointer;
    }
    .card:hover{ transform:translateY(-4px); background:#1e2230; box-shadow:0 12px 26px #0006; }
    .thumb{
      position:relative; border-radius:12px; overflow:hidden; background:#222; aspect-ratio:1/1;
      display:block;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    /* hover play ë²„íŠ¼ */
    .hover-play{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      opacity:0; transition:opacity .2s ease;
      background:linear-gradient(180deg, transparent 50%, rgba(0,0,0,.35) 100%);
    }
    .card:hover .hover-play{ opacity:1; }
    .play-circle{
      width:54px; height:54px; border-radius:50%; background:var(--brand); color:#111;
      display:flex; align-items:center; justify-content:center; font-weight:800; font-size:20px;
      box-shadow:0 6px 18px rgba(29,185,84,.45);
    }

    .card-title{ font-weight:800; margin:10px 2px 4px; font-size:15px; }
    .card-sub{ color:var(--brand); font-size:13px; margin:0 2px 2px; }

    /* ===== í•˜ë‹¨ í”Œë ˆì´ì–´ ===== */
    .player{
      grid-area:player; background:#181a1f; border-top:1px solid #000;
      display:grid; grid-template-columns: var(--sidebar-w) 1fr var(--sidebar-w);
      align-items:center; padding:8px 14px; gap:8px;
    }
    .p-info{display:flex; align-items:center; gap:12px; min-width:0;}
    #coverImg{ width:56px; height:56px; border-radius:10px; object-fit:cover; background:#222;}
    .title-wrap{min-width:0}
    .p-title{font-weight:800; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .p-artist{color:var(--brand); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}

    .p-center{ display:flex; flex-direction:column; align-items:center; gap:6px;}
    .p-ctrls{ display:flex; gap:10px; align-items:center;}
    .p-ctrls button{
      border:none; border-radius:999px; padding:8px 10px; background:#2a2a2a; color:#fff; cursor:pointer; font-weight:700;
    }
    .p-ctrls button.primary{ background:var(--brand); color:#111; font-weight:900; }
    .progress-wrap{ display:flex; align-items:center; gap:10px; width:100%; max-width:680px; }
    #progressContainer{flex:1; height:6px; background:#333; border-radius:999px; cursor:pointer;}
    #progress{height:100%; width:0%; background:var(--brand); border-radius:999px; transition:width .2s;}
    #timeDisplay{color:#aaa; font-size:12px; min-width:86px; display:flex; justify-content:space-between; gap:8px;}

    .p-right{ display:flex; align-items:center; gap:12px; justify-self:end;}
    #volumeControl{ width:110px; }
    /* ê°€ì‚¬ ë²„íŠ¼ì€ ì˜¤ë¥¸ìª½ ìª½ */
    .lyrics-toggle{
      border:none; background:#2a2a2a; color:#fff; padding:10px 12px; border-radius:999px; cursor:pointer; font-weight:800;
    }

    /* ===== ê°€ì‚¬ ì˜¤ë²„ë ˆì´ (ì‚¬ì´ë“œë°”/í”Œë ˆì´ì–´ ì œì™¸) ===== */
    .lyrics-overlay{
      position:fixed;
      left:var(--sidebar-w); right:0;
      top:0; bottom:var(--player-h);
      background:rgba(20,22,28,.96);
      border-left:1px solid #0b0b0b;
      z-index:50;
      display:none;
    }
    .lyrics-overlay.show{display:block; animation:fadeIn .25s ease}
    @keyframes fadeIn{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)} }
    .lyrics-head{
      position:absolute; right:12px; top:10px; display:flex; gap:8px;
    }
    .lyrics-close{
      border:none; background:#2a2a2a; color:#fff; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:800;
    }
    .lyrics-area{
      position:absolute; inset:64px 22px 64px 22px;
      overflow:auto; padding:6px 8px;
    }
    .lyrics-line{
      opacity:.6; color:#fff; font-size:20px; margin:8px 0; transition:.2s;
    }
    .lyrics-line.active{
      color:var(--brand); opacity:1; font-weight:900; background:#1a1f2b; padding:2px 8px; border-radius:8px;
    }
    .lyrics-foot{
      position:absolute; right:18px; bottom:18px; display:flex; gap:8px; align-items:center;
    }
    .instrumental-btn{
      border:none; background:var(--brand); color:#111; font-weight:900; padding:12px 16px; border-radius:999px; cursor:pointer;
      box-shadow:0 10px 24px rgba(29,185,84,.35);
    }
    .lyrics-empty{
      color:#bbb; font-size:18px; text-align:center; margin-top:40px;
    }

    /* ìŠ¤í¬ë¡¤ë°” ì‚´ì§ */
    ::-webkit-scrollbar{height:8px;width:8px}
    ::-webkit-scrollbar-thumb{background:#2b2b2b;border-radius:999px}
    ::-webkit-scrollbar-track{background:transparent}
    @media (max-width:920px){
      :root{ --sidebar-w:72px; }
      .logo span{display:none}
      .nav a span{display:none}
      .player{ grid-template-columns: var(--sidebar-w) 1fr 180px; }
      .p-right{gap:8px}
      #volumeControl{ width:80px;}
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- ===== ì‚¬ì´ë“œë°” ===== -->
    <aside class="sidebar">
      <div class="logo"><div class="dot"></div><span>ZEROMM</span></div>

      <div class="side-section-title">Menu</div>
      <nav class="nav">
        <a href="javascript:void(0)" class="active" id="tabSongs"><span>ì „ì²´ê³¡</span></a>
        <a href="javascript:void(0)" id="tabArtists"><span>ì•„í‹°ìŠ¤íŠ¸</span></a>
        <a href="javascript:void(0)" id="tabAlbums"><span>ì•¨ë²”</span></a>
        <a href="javascript:void(0)" id="tabPlaylist"><span>í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</span></a>
      </nav>

      <div class="side-section-title">Data Upload</div>
      <div class="install-app">
        <div class="title">ë¡œì»¬ ìŒì•… ë¶ˆëŸ¬ì˜¤ê¸°</div>
        <div class="upload-wrap">
          <input type="file" id="folderInput" class="folderInput" webkitdirectory directory multiple value="">
          <input type="text" id="searchInput" class="searchInput" placeholder="SEARCH">
        </div>
      </div>
    </aside>

    <!-- ===== ë©”ì¸ ===== -->
    <main class="main">
      <div class="top-tabs">
        <div class="section-title" id="sectionTitle">ì „ì²´ê³¡</div>
      </div>
      <div id="contentArea"></div>
    </main>

    <!-- ===== í•˜ë‹¨ í”Œë ˆì´ì–´ ===== -->
    <footer class="player" id="playerArea">
      <div class="p-info">
        <img id="coverImg" src="data/program/img/music-main.png" alt="cover">
        <div class="title-wrap">
          <div id="musicTitle" class="p-title"></div>
          <div id="musicArtist" class="p-artist"></div>
        </div>
      </div>

      <div class="p-center">
        <div class="p-ctrls">
          <button id="shuffleBtn">â‡„</button>
          <button id="prevBtn">â®</button>
          <button id="playBtn" class="primary">â–¶</button>
          <button id="nextBtn">â­</button>
          <button id="repeatBtn">â—¯</button>
        </div>
        <div class="progress-wrap">
          <div id="progressContainer"><div id="progress"></div></div>
          <div id="timeDisplay"><span id="currentTime">00:00</span><span id="duration">00:00</span></div>
        </div>
      </div>

      <div class="p-right">
        <span>ğŸ”Š</span>
        <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="0.5">
        <!-- ê°€ì‚¬ ë²„íŠ¼(íŠ¹ìˆ˜ê¸°í˜¸) -->
        <button class="lyrics-toggle" id="lyricsBtn">â™ª</button>
      </div>

      <audio id="player"></audio>
      <audio id="instrumentPlayer"></audio>
    </footer>

    <!-- ===== ê°€ì‚¬ ì˜¤ë²„ë ˆì´ (ì‚¬ì´ë“œë°”/í”Œë ˆì´ì–´ ì œì™¸) ===== -->
    <section id="lyricsOverlay" class="lyrics-overlay" aria-hidden="true">
      <div class="lyrics-head">
        <button id="lyricsClose" class="lyrics-close">âœ•</button>
      </div>
      <div id="lyricsScroll" class="lyrics-area">
        <div id="lyricsBlock" class="lyrics-block"></div>
      </div>
      <div class="lyrics-foot">
        <button id="instrumentalToggle" class="instrumental-btn">Instrumental: OFF</button>
      </div>
    </section>
  </div>

  <script>
    // ===== ë°ì´í„° êµ¬ì¡° / ì˜¨ë¼ì¸ ì„¤ì • =====
    // ê¹ƒí—ˆë¸Œ ê¸°ë³¸ (ë„¤ ë¦¬í¬ì§€í† ë¦¬ ê¸°ì¤€)
    const GITHUB_ROOT = "https://dongmungi.github.io/zeromm";
    const ONLINE_INFO = GITHUB_ROOT + "/data.json";
    const ONLINE_BASE = GITHUB_ROOT + "/data";
    const LOCAL_INFO = "./data.json";
    const LOCAL_BASE = "./data";

    let isOnlineMode = false;

    // ===== ê¸°ì¡´ ë³€ìˆ˜ / DOM (ê·¸ëŒ€ë¡œ ìœ ì§€) =====
    let songs = [];         // [{title, artist, album, genre, duration, file, cover, lrc, instrument, folder, txt}]
    let artists = {};       // {artistName: {name, info, image}}
    let albums = {};        // {albumName: {name, info, image}}
    let playlist = [];      // [{...song}]
    let currentTab = 'songs';
    let currentSong = null;
    let currentList = [];
    let repeatMode = 'none'; // none, one, all
    let shuffleMode = false;
    let instrumentOn = false; // ì „ì—­ ëª¨ë“œ
    let lrcLines = [];
    let lastPlayedIndex = 0;

    // ===== DOM =====
    const folderInput = document.getElementById('folderInput');
    const searchInput = document.getElementById('searchInput');
    const contentArea = document.getElementById('contentArea');
    const sectionTitle = document.getElementById('sectionTitle');

    const tabSongs = document.getElementById('tabSongs');
    const tabArtists = document.getElementById('tabArtists');
    const tabAlbums = document.getElementById('tabAlbums');
    const tabPlaylist = document.getElementById('tabPlaylist');

    const playerArea = document.getElementById('playerArea');
    const coverImg = document.getElementById('coverImg');
    const musicTitle = document.getElementById('musicTitle');
    const musicArtist = document.getElementById('musicArtist');
    const prevBtn = document.getElementById('prevBtn');
    const playBtn = document.getElementById('playBtn');
    const nextBtn = document.getElementById('nextBtn');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const repeatBtn = document.getElementById('repeatBtn');

    const player = document.getElementById('player');
    const instrumentPlayer = document.getElementById('instrumentPlayer');

    const progressContainer = document.getElementById('progressContainer');
    const progress = document.getElementById('progress');
    const currentTimeDisplay = document.getElementById('currentTime');
    const durationDisplay = document.getElementById('duration');
    const volumeControl = document.getElementById('volumeControl');

    const lyricsBtn = document.getElementById('lyricsBtn');
    const lyricsOverlay = document.getElementById('lyricsOverlay');
    const lyricsClose = document.getElementById('lyricsClose');
    const lyricsScroll = document.getElementById('lyricsScroll');
    const lyricsBlock = document.getElementById('lyricsBlock');
    const instrumentalToggle = document.getElementById('instrumentalToggle');

    // ===== íŒŒì¼ íŒŒì‹± (ë¡œì»¬ ì—…ë¡œë“œ ê¸°ì¡´ ë¡œì§ ìœ ì§€) =====
    folderInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      await parseFiles(files);
      switchTab('songs');
      loadPlaylist();
      saveLastOpened();
    });

    function parseInfo(txt) {
      const obj = {};
      txt.split(/\r?\n/).forEach(line => {
        const sep = line.indexOf(':');
        if (sep === -1) return;
        let key = line.slice(0, sep).trim();
        let val = line.slice(sep+1).trim();
        if (key && val && val !== 'none') {
          if (key.toLowerCase() === "artist") {
            obj[key] = val.split(",").map(v => v.trim()).filter(Boolean);
          } else {
            obj[key] = val;
          }
        }
      });
      return obj;
    }

    async function parseFiles(files) {
      songs = []; artists = {}; albums = {};
      let covers = {}, lrcs = {}, instrs = {}, songTxts = {};

      files.forEach(file => {
        const path = file.webkitRelativePath.split('/');
        // ê³¡ í´ë”ëª… ì¶”ì¶œ ( .../music/<musicname>/... )
        let folderName = null;
        const idxMusic = path.indexOf('music');
        if (idxMusic !== -1 && path.length > idxMusic+1) folderName = path[idxMusic+1];

        if (file.name === 'music-info.txt' && folderName) { covers[folderName] = null; }
        if (file.name.endsWith('.png') && folderName && path[idxMusic] === 'music') {
          covers[folderName] = URL.createObjectURL(file);
        }
        if (
  folderName &&
  (file.name.toLowerCase().endsWith('.lrc') ||
   (file.name.toLowerCase().endsWith('.txt') && file.name !== 'music-info.txt'))
) {
  if (file.name.toLowerCase().endsWith('.lrc')) {
    lrcs[folderName] = file;
  } else {
    songTxts[folderName] = file;
  }
}
        if (folderName && file.name.endsWith('.mp3') && file.name.includes('instrument')) {
          instrs[folderName] = file;
        }
        if (path[1] === 'artist' && file.name.endsWith('.png')) {
          artists[path[2]] = artists[path[2]] || {};
          artists[path[2]].image = URL.createObjectURL(file);
        }
        if (path[1] === 'album' && file.name.endsWith('.png')) {
          albums[path[2]] = albums[path[2]] || {};
          albums[path[2]].image = URL.createObjectURL(file);
        }
      });

      // ì•„í‹°ìŠ¤íŠ¸/ì•¨ë²” info
      await Promise.all(files.map(async file => {
        const path = file.webkitRelativePath.split('/');
        if (path[1] === 'artist' && file.name === 'artist-info.txt') {
          const txt = await file.text();
          const info = parseInfo(txt);
          artists[path[2]] = artists[path[2]] || {};
          Object.assign(artists[path[2]], info);
        }
        if (path[1] === 'album' && file.name === 'album-info.txt') {
          const txt = await file.text();
          const info = parseInfo(txt);
          albums[path[2]] = albums[path[2]] || {};
          Object.assign(albums[path[2]], info);
        }
      }));

      // ê³¡ info
      await Promise.all(files.map(async file => {
        const path = file.webkitRelativePath.split('/');
        if (file.name === 'music-info.txt') {
          const idxMusic = path.indexOf('music');
          const folder = (idxMusic !== -1 && path.length > idxMusic+1) ? path[idxMusic+1] : null;
          if (!folder) return;
          const txt = await file.text();
          const info = parseInfo(txt);
          let mp3 = files.find(f => f.webkitRelativePath.includes(`/music/${folder}/`) && f.name.endsWith('.mp3') && !f.name.includes('instrument'));
          if (!mp3) return;

          songs.push({
            ...info,
            file: mp3,
            cover: covers[folder] || 'data/program/img/music-main.png',
            lrc: lrcs[folder] || null,
            txt: songTxts[folder] || null,
            instrument: instrs[folder] || null,
            folder: folder
          });

          // LRCê°€ ë‚˜ì¤‘ì— ë¡œë”©ë  ê²½ìš° ë³´ê°•
          if (lrcs[folder]) {
            songs[songs.length - 1].lrc = lrcs[folder];
          }
        }
      }));

      songs.forEach(song => {
        if (Array.isArray(song.artist)) {
          song.artist.forEach(a => {
            if (!(a in artists)) artists[a] = {name: a, info: ''};
          });
        } else if (song.artist) {
          if (!(song.artist in artists)) artists[song.artist] = {name: song.artist, info: ''};
        }

        if (song.album && !(song.album in albums)) albums[song.album] = {name: song.album, info: ''};
      });
    }

    // ===== ì˜¨ë¼ì¸ ë¡œë“œ ë¡œì§ (data.json ê¸°ë°˜) =====
    async function tryLoadOnline() {
      try {
        // data.json ìœ„ì¹˜ (ì˜¨ë¼ì¸)
        const res = await fetch(ONLINE_INFO, {cache:'no-store'});
        if (!res.ok) throw new Error('no online info');
        const info = await res.json();

        isOnlineMode = true;
        // normalize keys (support "song" or "songs")
        const songList = info.songs || info.song || [];
        const artistList = info.artists || info.artist || [];
        const albumList = info.albums || info.album || [];

        // reset
        songs = []; artists = {}; albums = {};

        // artists
        (artistList || []).forEach(name => {
          if (!name) return;
          artists[name] = artists[name] || {name, image: ONLINE_BASE + '/artist/' + encodeURIComponent(name) + '/artist.png', infoUrl: ONLINE_BASE + '/artist/' + encodeURIComponent(name) + '/artist-info.txt'};
        });

        // albums
        (albumList || []).forEach(name => {
          if (!name) return;
          albums[name] = albums[name] || {name, image: ONLINE_BASE + '/album/' + encodeURIComponent(name) + '/album.png', infoUrl: ONLINE_BASE + '/album/' + encodeURIComponent(name) + '/album-info.txt'};
        });

        // songs: create song objects pointing to online URLs; try to fetch music-info.txt for metadata
        await Promise.all((songList || []).map(async (folder) => {
          if (!folder) return;
          const base = ONLINE_BASE + '/music/' + encodeURIComponent(folder);
          const infoUrl = base + '/music-info.txt';
          let meta = {};
          try {
            const t = await fetch(infoUrl).then(r => r.text());
            meta = parseInfo(t);
          } catch (e) {
            meta = {};
          }
          const songObj = {
            ...meta,
            title: meta.title || meta.Title || folder,
            artist: meta.artist || meta.Artist || (meta.Artists ? meta.Artists : ''),
            album: meta.album || meta.Album || '',
            file: base + '/music.mp3',
            cover: base + '/music.png',
            lrc: base + '/music-lyrics.lrc',
            instrument: base + '/music-instrument.mp3',
            folder: folder
          };
          songs.push(songObj);
        }));

        // render
        switchTab('songs');
        loadPlaylist();
        renderSongList(songs);
        console.log('Online mode: loaded', songs.length, 'songs');
        return true;
      } catch (err) {
        console.warn('Online load failed', err);
        isOnlineMode = false;
        return false;
      }
    }

    // ===== í—¬í¼: ë¡œì»¬ vs ì˜¨ë¼ì¸ ë¦¬ì†ŒìŠ¤ ì²˜ë¦¬ =====
    function urlForResource(r) {
      // r may be File object (from local upload) or string url
      if (!r) return null;
      if (typeof r === 'string') return r;
      try {
        return URL.createObjectURL(r);
      } catch {
        return null;
      }
    }

    // ===== íƒ­ ì „í™˜ =====
    tabSongs.addEventListener('click', ()=>switchTab('songs'));
    tabArtists.addEventListener('click', ()=>switchTab('artists'));
    tabAlbums.addEventListener('click', ()=>switchTab('albums'));
    tabPlaylist.addEventListener('click', ()=>switchTab('playlist'));

    function switchTab(tab){
      [tabSongs, tabArtists, tabAlbums, tabPlaylist].forEach(a=>a.classList.remove('active'));
      if(tab==='songs'){ tabSongs.classList.add('active'); sectionTitle.textContent='ì „ì²´ê³¡'; renderSongList(songs); }
      if(tab==='artists'){ tabArtists.classList.add('active'); sectionTitle.textContent='ì•„í‹°ìŠ¤íŠ¸'; renderArtistList(); }
      if(tab==='albums'){ tabAlbums.classList.add('active'); sectionTitle.textContent='ì•¨ë²”'; renderAlbumList(); }
      if(tab==='playlist'){ tabPlaylist.classList.add('active'); sectionTitle.textContent='í”Œë ˆì´ë¦¬ìŠ¤íŠ¸'; renderSongList(playlist, true); }
      currentTab = tab;
    }

    // ===== ë¦¬ìŠ¤íŠ¸ ë Œë” =====
    function renderSongList(list, isPlaylist=false){
      currentList = list || [];
      let html = '<div class="card-grid">';
      currentList.forEach((song, idx)=>{
        const coverSrc = song.cover ? (typeof song.cover === 'string' ? song.cover : urlForResource(song.cover)) : 'data/program/img/music-main.png';
        const artistText = Array.isArray(song.artist) ? song.artist.join(", ") : (song.artist || "");
        html += `
          <div class="card" onclick="showSongDetail(${idx}, ${isPlaylist})">
            <a class="thumb">
              <img src="${coverSrc}" alt="cover">
              <div class="hover-play">
                <div class="play-circle" onclick="event.stopPropagation(); playFromDetail(${isPlaylist}, ${idx});">â–¶</div>
              </div>
            </a>
            <div class="card-title">${escapeHtml(song.title || '(ì œëª©ì—†ìŒ)')}</div>
            <div class="card-sub">${escapeHtml(artistText)}</div>
          </div>`;
      });
      html += '</div>';
      contentArea.innerHTML = html;
    }

    function renderArtistList(){
      let html = '<div class="card-grid">';
      Object.keys(artists).forEach(name=>{
        const a=artists[name];
        const img = a.image || 'data/program/img/artist-main.png';
        html += `
          <div class="card" onclick="showArtist('${escapeJs(name)}')">
            <a class="thumb">
              <img src="${img}" alt="artist">
              <div class="hover-play" style="pointer-events:none;"></div>
            </a>
            <div class="card-title">${escapeHtml(a.name || name)}</div>
            <div class="card-sub">ì•„í‹°ìŠ¤íŠ¸</div>
          </div>`;
      });
      html += '</div>';
      contentArea.innerHTML = html;
    }

    function renderAlbumList(){
      let html = '<div class="card-grid">';
      Object.keys(albums).forEach(name=>{
        const a=albums[name];
        const img = a.image || 'data/program/img/album-main.png';
        html += `
          <div class="card" onclick="showAlbum('${escapeJs(name)}')">
            <a class="thumb">
              <img src="${img}" alt="album">
              <div class="hover-play" style="pointer-events:none;"></div>
            </a>
            <div class="card-title">${escapeHtml(a.name || name)}</div>
            <div class="card-sub">ì•¨ë²”</div>
          </div>`;
      });
      html += '</div>';
      contentArea.innerHTML = html;
    }

    // ìƒì„¸/í”Œë ˆì´ ê´€ë ¨
    window.showSongDetail = function(idx, isPlaylist=false){
      playFromDetail(isPlaylist, idx);
    };

    window.showArtist = function(artistName){
      const list = songs.filter(s =>
        Array.isArray(s.artist)
          ? s.artist.includes(artistName)
          : s.artist === artistName
      );
      renderSongList(list);
    };

    window.showAlbum = function(albumName){
      const list = songs.filter(s => s.album === albumName);
      renderSongList(list);
    };

    window.playFromDetail = function(isPlaylist, idx){
      const list = isPlaylist ? playlist : currentList;
      if (!list || !list[idx]) return;
      selectSong(list[idx], list);
    };

    // ===== ê²€ìƒ‰ =====
    searchInput.addEventListener('input', () => {
      const term = searchInput.value.trim().toLowerCase();
      if(currentTab==='songs'){
        const filtered = songs.filter(s =>
          (s.title||'').toLowerCase().includes(term) ||
          (Array.isArray(s.artist) ? s.artist.join(", ") : (s.artist||'')).toLowerCase().includes(term) ||
          (s.album||'').toLowerCase().includes(term)
        );
        renderSongList(filtered);
      } else if (currentTab==='artists'){
        const filtered = Object.keys(artists).filter(n =>
          n.toLowerCase().includes(term) ||
          (artists[n].info||'').toLowerCase().includes(term)
        );
        let html='<div class="card-grid">';
        filtered.forEach(n=>{
          const a=artists[n];
          html += `
            <div class="card" onclick="showArtist('${escapeJs(n)}')">
              <a class="thumb"><img src="${a.image || 'data/program/img/artist-main.png'}"><div class="hover-play" style="pointer-events:none;"></div></a>
              <div class="card-title">${escapeHtml(a.name)}</div>
              <div class="card-sub">ì•„í‹°ìŠ¤íŠ¸</div>
            </div>`;
        });
        html+='</div>'; contentArea.innerHTML=html;
      } else if (currentTab==='albums'){
        const filtered = Object.keys(albums).filter(n =>
          n.toLowerCase().includes(term) ||
          (albums[n].info||'').toLowerCase().includes(term)
        );
        let html='<div class="card-grid">';
        filtered.forEach(n=>{
          const a=albums[n];
          html += `
            <div class="card" onclick="showAlbum('${escapeJs(n)}')">
              <a class="thumb"><img src="${a.image || 'data/program/img/album-main.png'}"><div class="hover-play" style="pointer-events:none;"></div></a>
              <div class="card-title">${escapeHtml(a.name)}</div>
              <div class="card-sub">ì•¨ë²”</div>
            </div>`;
        });
        html+='</div>'; contentArea.innerHTML=html;
      } else if (currentTab==='playlist'){
        const filtered = playlist.filter(s =>
          (s.title||'').toLowerCase().includes(term) ||
          (s.artist||'').toLowerCase().includes(term) ||
          (s.album||'').toLowerCase().includes(term)
        );
        renderSongList(filtered, true);
      }
    });

    // ===== ì¬ìƒ ë¡œì§ (ìˆ˜ì •: ë¡œì»¬ File or ì˜¨ë¼ì¸ URL ëª¨ë‘ ì§€ì›) =====
    function selectSong(song, list){
      currentSong = song;
      currentList = list || songs;
      lastPlayedIndex = currentList.indexOf(song) || 0;

      coverImg.src = song.cover ? (typeof song.cover === 'string' ? song.cover : urlForResource(song.cover)) : 'data/program/img/music-main.png';
      musicTitle.textContent = song.title || '(ì œëª©ì—†ìŒ)';
      musicArtist.textContent = Array.isArray(song.artist)
        ? song.artist.join(", ")
        : (song.artist || "");

      // íŒŒì¼ ì²˜ë¦¬: File (local upload) ë˜ëŠ” URL string (online)
      if (song.file && typeof song.file === 'string') {
        player.src = song.file;
      } else if (song.file) {
        try { player.src = urlForResource(song.file); } catch { player.src = ''; }
      } else {
        player.src = '';
      }

      if (song.instrument) {
        if (typeof song.instrument === 'string') instrumentPlayer.src = song.instrument;
        else instrumentPlayer.src = urlForResource(song.instrument);
      } else {
        instrumentOn = false;
        instrumentalToggle.textContent = 'Instrumental: OFF';
        instrumentPlayer.src = '';
      }

      // ê°€ì‚¬ ì¤€ë¹„
      lrcLines = [];
      console.log("selectSong lrc=", song.lrc);
      if (song.lrc) {
        if (typeof song.lrc === "string") {
          fetch(song.lrc).then(res => {
            if (!res.ok) throw new Error('no lrc');
            return res.text();
          }).then(txt => {
            lrcLines = parseLRC(txt);
            buildLyricsView();
          }).catch(_ => {
            buildLyricsView(`<div class="lyrics-empty">í•´ë‹¹ ê³¡ì€ ê°€ì‚¬ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>`);
          });
        } else if (typeof song.lrc.text === "function") {
          song.lrc.text().then(txt => {
            lrcLines = parseLRC(txt);
            buildLyricsView();
          }).catch(_ => {
            buildLyricsView(`<div class="lyrics-empty">í•´ë‹¹ ê³¡ì€ ê°€ì‚¬ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>`);
          });
        } else {
          buildLyricsView(`<div class="lyrics-empty">í•´ë‹¹ ê³¡ì€ ê°€ì‚¬ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>`);
        }
      } else if (song.txt) {
        if (typeof song.txt === 'string') {
          fetch(song.txt).then(r=>r.text()).then(txt=>{
            buildLyricsView(`<pre style="white-space:pre-wrap;line-height:1.6">${escapeHtml(txt)}</pre>`);
          }).catch(()=>buildLyricsView(`<div class="lyrics-empty">í•´ë‹¹ ê³¡ì€ ê°€ì‚¬ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>`));
        } else {
          song.txt.text().then(txt => {
            buildLyricsView(`<pre style="white-space:pre-wrap;line-height:1.6">${escapeHtml(txt)}</pre>`);
          }).catch(()=>buildLyricsView(`<div class="lyrics-empty">í•´ë‹¹ ê³¡ì€ ê°€ì‚¬ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>`));
        }
      } else {
        buildLyricsView(`<div class="lyrics-empty">í•´ë‹¹ ê³¡ì€ ê°€ì‚¬ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>`);
      }

      startPlaybackFrom(0);
      saveLastPlayed();
    }

    // í˜„ì¬ ëª¨ë“œì— ë§ì¶° íŠ¹ì • ì‹œì ë¶€í„° ì¬ìƒ
    function startPlaybackFrom(timeSec){
      const vol = volumeControl.value;
      const useInst = instrumentOn && currentSong?.instrument;
      if(useInst){
        instrumentPlayer.currentTime = timeSec;
        instrumentPlayer.volume = vol;
        instrumentPlayer.play();
        player.pause();
      }else{
        player.currentTime = timeSec;
        player.volume = vol;
        player.play();
        instrumentPlayer.pause();
      }
      playBtn.textContent = 'â¸';
    }

    function pauseBoth(){
      player.pause(); instrumentPlayer.pause();
      playBtn.textContent = 'â–¶';
    }

    playBtn.addEventListener('click', ()=>{
      const active = (instrumentOn && currentSong?.instrument) ? instrumentPlayer : player;
      if(active.paused){ startPlaybackFrom(active.currentTime || 0); }
      else{ pauseBoth(); }
    });
    prevBtn.addEventListener('click', playPrev);
    nextBtn.addEventListener('click', playNext);

    shuffleBtn.addEventListener('click', ()=>{
      shuffleMode = !shuffleMode;
      shuffleBtn.classList.toggle('primary', shuffleMode);
    });
    repeatBtn.addEventListener('click', ()=>{
      if (repeatMode === 'none') repeatMode = 'all';
      else if (repeatMode === 'all') repeatMode = 'one';
      else repeatMode = 'none';
      repeatBtn.textContent = (repeatMode==='none')?'â—¯':(repeatMode==='all'?'â†º':'â†ºÂ¹');
      repeatBtn.classList.toggle('primary', repeatMode!=='none');
    });

    // ë³¼ë¥¨/ì§„í–‰
    volumeControl.addEventListener('input', ()=>{
      player.volume = volumeControl.value;
      instrumentPlayer.volume = volumeControl.value;
    });

    function getActivePair(){
      const useInst = instrumentOn && currentSong?.instrument;
      return { curEl: useInst ? instrumentPlayer : player, otherEl: useInst ? player : instrumentPlayer };
    }

    player.addEventListener('timeupdate', updateProgress);
    instrumentPlayer.addEventListener('timeupdate', updateProgress);

    progressContainer.addEventListener('click', (e) => {
      const percent = e.offsetX / progressContainer.clientWidth;
      const { curEl, otherEl } = getActivePair();
      const dur = curEl.duration || 0;
      const target = percent * dur;
      curEl.currentTime = target; otherEl.currentTime = target;
      updateProgress();
    });

    function updateProgress(){
      const { curEl } = getActivePair();
      const cur = curEl.currentTime || 0;
      const dur = curEl.duration || 0;
      const percent = dur ? cur / dur * 100 : 0;
      progress.style.width = percent + '%';
      currentTimeDisplay.textContent = formatTime(cur);
      durationDisplay.textContent = formatTime(dur);
      syncLyrics(cur);
    }
    function formatTime(sec){
      if (isNaN(sec)) return "00:00";
      const m = Math.floor(sec / 60), s = Math.floor(sec % 60);
      return `${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
    }

    player.addEventListener('ended', handleEnded);
    instrumentPlayer.addEventListener('ended', handleEnded);
    function handleEnded(){
      if (repeatMode === 'one') startPlaybackFrom(0);
      else playNext();
    }
    function playPrev(){
      let idx = lastPlayedIndex;
      if (shuffleMode) idx = Math.floor(Math.random()*currentList.length);
      else idx = (idx - 1 + currentList.length) % currentList.length;
      selectSong(currentList[idx], currentList);
    }
    function playNext(){
      let idx = lastPlayedIndex;
      if (shuffleMode) idx = Math.floor(Math.random()*currentList.length);
      else idx = (idx + 1) % currentList.length;
      selectSong(currentList[idx], currentList);
    }

    // ===== í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ (ê°„ë‹¨: í˜„ì¬ íƒ­ì—ì„œ + ë²„íŠ¼ ì—†ì´ hover â–¶ë¡œ ì¬ìƒë§Œ, add/removeëŠ” í•„ìš” ì‹œ í™•ì¥) =====
    function loadPlaylist(){
      const data = localStorage.getItem('ZEROMM_PLAYLIST');
      if (data){
        try{
          const arr = JSON.parse(data);
          playlist = arr.map(info => songs.find(s => s.title===info.title && s.artist===info.artist)).filter(Boolean);
        }catch(_){}
      }
    }
    function savePlaylist(){
      localStorage.setItem('ZEROMM_PLAYLIST', JSON.stringify(playlist.map(s => ({title:s.title, artist:s.artist}))));
    }

    function saveLastPlayed(){
      if (!currentSong) return;
      localStorage.setItem('ZEROMM_LAST', JSON.stringify({title: currentSong.title, artist: currentSong.artist}));
    }
    function saveLastOpened(){ localStorage.setItem('ZEROMM_OPENED', '1'); }

    window.addEventListener('DOMContentLoaded', async ()=>{
      // ì´ˆê¸°: ì˜¨ë¼ì¸ ì‹œë„ -> ì‹¤íŒ¨í•˜ë©´ ë¡œì»¬ ëª¨ë“œ (ì‚¬ìš©ì ì—…ë¡œë“œ)
      const ok = await tryLoadOnline();
      if (!ok) {
        // ì˜¨ë¼ì¸ ì‹¤íŒ¨: ì•ˆë‚´ í…ìŠ¤íŠ¸ë¥¼ ë³´ì—¬ì£¼ê³  ë¡œì»¬ ì—…ë¡œë“œ ëŒ€ê¸°
        contentArea.innerHTML = `<div style="color:#bbb;padding:20px;text-align:center">ì˜¤í”„ë¼ì¸ ëª¨ë“œì…ë‹ˆë‹¤. ì™¼ìª½ 'ë¡œì»¬ ìŒì•… ë¶ˆëŸ¬ì˜¤ê¸°'ì—ì„œ data í´ë” ì„ íƒ ë˜ëŠ” data.jsonì„ ê°™ì€ ìœ„ì¹˜ì— ë‘ì„¸ìš”.</div>`;
      } else {
        // ì˜¨ë¼ì¸ ì„±ê³µ: ì´ë¯¸ ë Œë”ë¨
      }

      // ìœ ì§€: ê¸°ì¡´ ë¡œì»¬ ì—…ë¡œë“œ handlerê°€ ì‘ë™í•˜ë¯€ë¡œ ì‚¬ìš©ìê°€ ë¡œì»¬ ì—…ë¡œë“œí•˜ë©´ ë°”ë¡œ ì „í™˜
    });

    // ===== ê°€ì‚¬ ì²˜ë¦¬ =====
    function parseLRC(txt){
      const lines = txt.split(/\r?\n/);
      const result = [];
      // [mm:ss], [mm:ss.xx], [mm:ss.xxx] ëª¨ë‘ ì§€ì›
      const timeReg = /\[(\d{2}):(\d{2})(?:\.(\d{1,3}))?\]/;
      lines.forEach(line=>{
        const match = line.match(timeReg);
        if (match){
          const min = parseInt(match[1]);
          const sec = parseInt(match[2]);
          const msec = match[3] ? parseInt(match[3]) : 0;
          // ìë¦¬ìˆ˜ì— ë”°ë¼ ë°€ë¦¬ì´ˆ ê³„ì‚° ë³´ì •
          const msFactor = match[3] && match[3].length === 3 ? 1000 : 100;
          const time = min * 60 + sec + msec / msFactor;
          const text = line.replace(timeReg,'').trim();
          result.push({time, text});
        }
      });
      return result.sort((a,b)=>a.time-b.time);
    }

    function buildLyricsView(customHtml){
      if (customHtml){
        lyricsBlock.innerHTML = customHtml;
        return;
      }
      if (!lrcLines.length){
        lyricsBlock.innerHTML = `<div class="lyrics-empty">í•´ë‹¹ ê³¡ì€ ê°€ì‚¬ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>`;
        return;
      }
      let html = '';
      lrcLines.forEach((l, i)=>{ html += `<div class="lyrics-line" data-idx="${i}">${escapeHtml(l.text)}</div>`; });
      lyricsBlock.innerHTML = html;
    }

    function syncLyrics(curTime){
      if (!lrcLines.length) return;
      let activeIdx = -1;
      for (let i=0;i<lrcLines.length;i++){
        const n = lrcLines[i], next = lrcLines[i+1];
        if (curTime >= n.time && (i===lrcLines.length-1 || curTime < next.time)){ activeIdx = i; break; }
      }
      const nodes = lyricsBlock.querySelectorAll('.lyrics-line');
      nodes.forEach(n => n.classList.remove('active'));
      if (activeIdx >= 0 && nodes[activeIdx]){
        const el = nodes[activeIdx];
        el.classList.add('active');
        // ìë™ ìŠ¤í¬ë¡¤ (ê°€ìš´ë° ê·¼ì²˜ë¡œ)
        const container = lyricsScroll;
        const offset = el.offsetTop - container.clientHeight/2 + el.clientHeight/2;
        container.scrollTo({ top: Math.max(offset,0), behavior:'smooth' });
      }
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }
    function escapeJs(s){ return String(s).replace(/'/g,"\\'"); }

    // ===== ê°€ì‚¬ í† ê¸€ & ì˜¤ë²„ë ˆì´ ì»¨íŠ¸ë¡¤ =====
    lyricsBtn.addEventListener('click', ()=>{
      lyricsOverlay.classList.add('show');
      lyricsOverlay.setAttribute('aria-hidden','false');
    });
    lyricsClose.addEventListener('click', ()=>{
      lyricsOverlay.classList.remove('show');
      lyricsOverlay.setAttribute('aria-hidden','true');
    });

    // ===== Instrumental í† ê¸€ (ì˜¤ë²„ë ˆì´ ì˜¤ë¥¸ìª½ í•˜ë‹¨) =====
    instrumentalToggle.addEventListener('click', ()=>{
      if (!currentSong) return;
      const hasInst = !!currentSong.instrument;
      const active = (instrumentOn && hasInst) ? instrumentPlayer : player;
      const t = active.currentTime || 0;
      const wasPlaying = !active.paused;

      instrumentOn = !instrumentOn;
      instrumentalToggle.textContent = 'Instrumental: ' + (instrumentOn && hasInst ? 'ON' : 'OFF');

      if (instrumentOn && hasInst){
        player.pause();
        instrumentPlayer.currentTime = t;
        if (wasPlaying) instrumentPlayer.play();
      }else{
        instrumentPlayer.pause();
        player.currentTime = t;
        if (wasPlaying) player.play();
      }
      playBtn.textContent = wasPlaying ? 'â¸' : 'â–¶';
      // ê°€ì‚¬ ì‹±í¬ëŠ” updateProgressê°€ ê³„ì† ì²˜ë¦¬
    });
  </script>
</body>
</html>
